- name: Install Minikube on Debian VM
  hosts: target_vm
  become: yes
  vars:
    minikube_version: "latest"
    kubectl_version: ""
    crictl_version: "1.29.0"
    cni_version: "1.4.0"
  
  tasks:
    # =============================================================================
    # SYSTEM PREPARATION
    # =============================================================================
    - name: "ğŸ“‹ PREPARATION â†’ Update package cache"
      apt:
        update_cache: yes
        cache_valid_time: 3600
      
    - name: "ğŸ“¦ PREPARATION â†’ Install system dependencies"
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - apparmor-utils
          - conntrack
          - containerd
          - iptables
          - docker.io  # Required for minikube none driver even with containerd
        state: present
        update_cache: yes

    - name: "âš™ï¸ PREPARATION â†’ Configure kernel parameters for minikube"
      sysctl:
        name: fs.protected_regular
        value: '0'
        state: present
        reload: yes

    - name: "ğŸ‘¤ PREPARATION â†’ Add debian user to docker group"
      user:
        name: debian
        groups: docker
        append: yes

    # =============================================================================
    # CONTAINER RUNTIME SETUP
    # =============================================================================
    - name: "ğŸ³ CONTAINERD â†’ Create configuration directory"
      file:
        path: /etc/containerd
        state: directory
        mode: '0755'
        owner: root
        group: root

    - name: "ğŸ³ CONTAINERD â†’ Configure containerd runtime"
      copy:
        dest: /etc/containerd/config.toml
        content: |
          version = 2
          
          [plugins."io.containerd.grpc.v1.cri"]
            [plugins."io.containerd.grpc.v1.cri".containerd]
              [plugins."io.containerd.grpc.v1.cri".containerd.runtimes]
                [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
                  runtime_type = "io.containerd.runc.v2"
                  [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
                    SystemdCgroup = true
        mode: '0644'
        owner: root
        group: root
      notify: restart containerd

    - name: "ğŸ³ CONTAINERD â†’ Enable and start containerd service"
      systemd:
        name: containerd
        enabled: yes
        state: started

    - name: "ğŸ³ DOCKER â†’ Enable and start Docker service (required for minikube none driver)"
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: "ğŸ” CONTAINERD â†’ Verify containerd is running"
      systemd:
        name: containerd
        state: started
      register: containerd_status
      failed_when: containerd_status.status.ActiveState != "active"

    # =============================================================================
    # CONTAINER RUNTIME TOOLS
    # =============================================================================
    - name: "ğŸ”§ CRICTL â†’ Download crictl v{{ crictl_version }} for container debugging"
      get_url:
        url: "https://github.com/kubernetes-sigs/cri-tools/releases/download/v{{ crictl_version }}/crictl-v{{ crictl_version }}-linux-amd64.tar.gz"
        dest: /tmp/crictl.tar.gz
        mode: '0644'
        timeout: 30
      register: crictl_download
      retries: 3
      delay: 5

    - name: "ğŸ”§ CRICTL â†’ Extract crictl binary"
      unarchive:
        src: /tmp/crictl.tar.gz
        dest: /usr/local/bin
        remote_src: yes
        mode: '0755'
        owner: root
        group: root
      when: crictl_download is succeeded

    - name: "ğŸ”§ CRICTL â†’ Configure crictl for containerd"
      copy:
        dest: /etc/crictl.yaml
        content: |
          runtime-endpoint: unix:///var/run/containerd/containerd.sock
          image-endpoint: unix:///var/run/containerd/containerd.sock
          timeout: 2
        mode: '0644'
        owner: root
        group: root

    - name: "ğŸ”§ CRICTL â†’ Verify crictl installation"
      command: crictl version
      register: crictl_verify
      failed_when: crictl_verify.rc != 0
      changed_when: false

    - name: "ğŸ§¹ CRICTL â†’ Clean up crictl archive"
      file:
        path: /tmp/crictl.tar.gz
        state: absent
      when: crictl_download is succeeded

    # =============================================================================
    # NETWORKING SETUP
    # =============================================================================
    - name: "ğŸŒ NETWORKING â†’ Create CNI bin directory"
      file:
        path: /opt/cni/bin
        state: directory
        mode: '0755'
        owner: root
        group: root

    - name: "ğŸŒ NETWORKING â†’ Download CNI plugins v{{ cni_version }}"
      get_url:
        url: "https://github.com/containernetworking/plugins/releases/download/v{{ cni_version }}/cni-plugins-linux-amd64-v{{ cni_version }}.tgz"
        dest: /tmp/cni-plugins.tgz
        mode: '0644'
        timeout: 30
      register: cni_download
      retries: 3
      delay: 5

    - name: "ğŸŒ NETWORKING â†’ Extract CNI plugins"
      unarchive:
        src: /tmp/cni-plugins.tgz
        dest: /opt/cni/bin
        remote_src: yes
        mode: '0755'
        owner: root
        group: root
      when: cni_download is succeeded

    - name: "ğŸ§¹ NETWORKING â†’ Clean up CNI archive"
      file:
        path: /tmp/cni-plugins.tgz
        state: absent
      when: cni_download is succeeded

    # =============================================================================
    # KUBERNETES TOOLING
    # =============================================================================

    - name: "â˜¸ï¸ KUBECTL â†’ Get latest stable kubectl version"
      uri:
        url: https://dl.k8s.io/release/stable.txt
        method: GET
        return_content: yes
        timeout: 10
      register: kubectl_version_response
      retries: 3
      delay: 5
    
    - name: "â˜¸ï¸ KUBECTL â†’ Download kubectl {{ kubectl_version_response.content.strip() }}"
      get_url:
        url: "https://dl.k8s.io/release/{{ kubectl_version_response.content.strip() }}/bin/linux/amd64/kubectl"
        dest: /usr/local/bin/kubectl
        mode: '0755'
        owner: root
        group: root
        timeout: 60
      register: kubectl_download
      retries: 3
      delay: 5

    - name: "â˜¸ï¸ KUBECTL â†’ Verify kubectl installation"
      command: kubectl version --client=true --output=yaml
      register: kubectl_verify
      failed_when: kubectl_verify.rc != 0
      changed_when: false
    
    - name: "ğŸš€ MINIKUBE â†’ Download minikube {{ minikube_version }}"
      get_url:
        url: "https://storage.googleapis.com/minikube/releases/{{ minikube_version }}/minikube-linux-amd64"
        dest: /usr/local/bin/minikube
        mode: '0755'
        owner: root
        group: root
        timeout: 120
      register: minikube_download
      retries: 3
      delay: 5

    - name: "ğŸš€ MINIKUBE â†’ Verify minikube installation"
      command: minikube version --output=json
      register: minikube_verify
      failed_when: minikube_verify.rc != 0
      changed_when: false

    # =============================================================================
    # USER ENVIRONMENT SETUP
    # =============================================================================
    - name: "ğŸ“ SETUP â†’ Create minikube user directory"
      file:
        path: /home/debian/.minikube
        state: directory
        owner: debian
        group: debian
        mode: '0755'
    
    - name: "ğŸ“ SETUP â†’ Create bash completion directory"
      file:
        path: /etc/bash_completion.d
        state: directory
        mode: '0755'
    
    - name: "ğŸ’» SETUP â†’ Configure kubectl bash completion"
      shell: |
        kubectl completion bash > /etc/bash_completion.d/kubectl
      args:
        creates: /etc/bash_completion.d/kubectl
    
    - name: "ğŸ’» SETUP â†’ Configure minikube bash completion"
      shell: |
        minikube completion bash > /etc/bash_completion.d/minikube
      args:
        creates: /etc/bash_completion.d/minikube

    # =============================================================================
    # PRE-START VERIFICATION
    # =============================================================================
    - name: "âœ… VERIFY â†’ Check all required services are active"
      systemd:
        name: "{{ item }}"
        state: started
      register: service_check
      failed_when: service_check.status.ActiveState != "active"
      loop:
        - containerd
        - docker
      loop_control:
        label: "{{ item }} service"

    - name: "âœ… VERIFY â†’ Test container runtime with crictl"
      command: crictl info
      register: crictl_test
      failed_when: crictl_test.rc != 0
      changed_when: false

    - name: "âœ… VERIFY â†’ Check CNI plugins are installed"
      find:
        paths: /opt/cni/bin
        patterns: "bridge,host-local,portmap"
        file_type: file
      register: cni_plugins
      failed_when: cni_plugins.matched < 3
    
    # =============================================================================
    # MINIKUBE SERVICE CONFIGURATION
    # =============================================================================
    - name: "âš™ï¸ SERVICE â†’ Create minikube systemd service"
      copy:
        dest: /etc/systemd/system/minikube.service
        content: |
          [Unit]
          Description=Minikube Kubernetes Cluster
          After=containerd.service network.target
          
          [Service]
          Type=oneshot
          User=root
          Group=root
          Environment=HOME=/root
          Environment=MINIKUBE_IN_STYLE=false
          ExecStartPre=/bin/bash -c 'until systemctl is-active containerd; do sleep 5; done'
          ExecStart=/usr/local/bin/minikube start --driver=none --apiserver-port=8443 --container-runtime=containerd --apiserver-ips={{ ansible_default_ipv4.address }} --apiserver-names={{ ansible_fqdn }},{{ ansible_hostname }}
          ExecStop=/usr/local/bin/minikube stop
          TimeoutStartSec=1200
          TimeoutStopSec=300
          RemainAfterExit=yes
          Restart=no
          
          [Install]
          WantedBy=multi-user.target
        mode: '0644'
        owner: root
        group: root
      tags: systemd
      register: systemd_service_created
    
    - name: "âš™ï¸ SERVICE â†’ Reload systemd daemon"
      systemd:
        daemon_reload: yes
      when: systemd_service_created is changed
      tags: systemd

    - name: "ğŸš€ SERVICE â†’ Enable and start minikube service"
      systemd:
        name: minikube
        enabled: yes
        state: started
      tags: systemd
      register: minikube_service

    - name: "ğŸ” SERVICE â†’ Verify minikube service is running"
      systemd:
        name: minikube
        state: started
      register: service_status
      failed_when: service_status.status.ActiveState not in ["active", "activating"]
      tags: systemd

    # =============================================================================
    # CLUSTER READINESS AND REMOTE ACCESS
    # =============================================================================
    - name: "â³ CLUSTER â†’ Wait for minikube cluster to be ready"
      shell: |
        timeout 120 bash -c 'until kubectl get nodes 2>/dev/null && kubectl get pods -n kube-system 2>/dev/null; do sleep 5; done'
      become_user: root
      environment:
        HOME: /root
      tags: remote_access
      register: cluster_ready
      retries: 2
      delay: 30

    - name: "â˜¸ï¸ CLUSTER â†’ Verify cluster node status"
      shell: kubectl get nodes --no-headers
      become_user: root
      environment:
        HOME: /root
      register: node_status
      failed_when: "'Ready' not in node_status.stdout"
      tags: remote_access

    - name: "ğŸ” KUBECONFIG â†’ Extract minikube kubeconfig for remote access"
      shell: |
        kubectl config view --raw --flatten
      become_user: root
      environment:
        HOME: /root
        KUBECONFIG: /root/.kube/config
      register: minikube_kubeconfig
      tags: remote_access

    - name: "ğŸ” KUBECONFIG â†’ Create external access kubeconfig"
      copy:
        content: "{{ minikube_kubeconfig.stdout | regex_replace('https://[^:]+:', 'https://' + ansible_default_ipv4.address + ':') }}"
        dest: /tmp/minikube-{{ ansible_hostname }}-kubeconfig
        mode: '0600'
      delegate_to: localhost
      become: no
      tags: remote_access
      register: kubeconfig_created

    # =============================================================================
    # FINAL VERIFICATION AND STATUS
    # =============================================================================
    - name: "âœ… VERIFICATION â†’ Test cluster connectivity"
      shell: |
        kubectl get nodes -o wide && kubectl get pods -n kube-system
      become_user: root
      environment:
        HOME: /root
      register: final_cluster_test
      tags: remote_access

    - name: "ğŸ“Š STATUS â†’ Display remote access information"
      debug:
        msg: |
          ğŸ‰ Minikube remote access configured successfully!
          
          ğŸ“„ Kubeconfig saved to: /tmp/minikube-{{ ansible_hostname }}-kubeconfig
          
          ğŸ”§ To add this cluster to your local kubectl config:
          KUBECONFIG=~/.kube/config:/tmp/minikube-{{ ansible_hostname }}-kubeconfig kubectl config view --flatten > ~/.kube/config.new && mv ~/.kube/config.new ~/.kube/config
          
          ğŸ¯ Then use this context:
          kubectl config use-context minikube
          
          ğŸŒ API Server: https://{{ ansible_default_ipv4.address }}:8443
      tags: remote_access
    
    - name: "ğŸ COMPLETION â†’ Display final status"
      debug:
        msg: |
          âœ… Minikube installation completed successfully!
          
          ğŸ“‹ Configuration Summary:
          â€¢ Driver: none (runs directly on VM)
          â€¢ Container Runtime: containerd
          â€¢ Auto-start: enabled on boot
          â€¢ API Server: https://{{ ansible_default_ipv4.address }}:8443
          â€¢ Kubectl: {{ kubectl_version_response.content.strip() }}
          â€¢ Minikube: {{ minikube_verify.stdout | from_json | json_query('minikubeVersion') }}
          â€¢ Crictl: v{{ crictl_version }} (for container debugging)
          
          ğŸ”§ Cluster Management:
          â€¢ SSH Access: ssh debian@{{ ansible_host | default(ansible_hostname) }}
          â€¢ Check Status: sudo minikube status
          â€¢ View Nodes: sudo kubectl get nodes
          â€¢ Service Status: sudo systemctl status minikube
          
          ğŸ› Debugging Tools:
          â€¢ Container Info: sudo crictl info
          â€¢ List Containers: sudo crictl ps -a
          â€¢ Container Logs: sudo crictl logs <container-id>
          â€¢ Pod Sandboxes: sudo crictl pods
          
          âš¡ Service Control:
          â€¢ Start: sudo systemctl start minikube
          â€¢ Stop: sudo systemctl stop minikube  
          â€¢ Disable: sudo systemctl disable minikube
          
          âš ï¸  Important Notes:
          â€¢ Root privileges required (use sudo) for none driver
          â€¢ Allow 2-3 minutes for complete startup
          â€¢ Service timeout: 20 minutes for initial setup
          â€¢ Restart policy: disabled to prevent infinite loops

  handlers:
    - name: restart containerd
      systemd:
        name: containerd
        state: restarted